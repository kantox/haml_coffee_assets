name: build

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        rails: ['8.1', '8.0', '7.2', '7.1', '7.0', '6.1']                               # we add ".0" in the Gemfile so latest patch version used
        ruby: [ruby-3.4, ruby-3.3, ruby-3.2, ruby-3.1, ruby-3.0] # ruby/setup-ruby will use latest patch version
        sprockets: ['4', '3']
        include:
          # Rails 5.2 on Ruby 2.6
          - rails: '5.2'
            ruby: ruby-2.6
            sprockets: '4'
          - rails: '5.2'
            ruby: ruby-2.6
            sprockets: '3'
        exclude:
          # Rails 8.0/8.1 doesn't support Ruby 3.0/3.1
          - rails: '8.1'
            ruby: ruby-3.1
          - rails: '8.1'
            ruby: ruby-3.0
          - rails: '8.0'
            ruby: ruby-3.1
          - rails: '8.0'
            ruby: ruby-3.0
          # Rails 7.2 doesn't support Ruby 3.0
          - rails: '7.2'
            ruby: ruby-3.0
    name: "Rails ${{ matrix.rails }} with Sprockets ${{ matrix.sprockets }} on ${{ matrix.ruby }}"
    env:
      RAILS_VER: ${{ matrix.rails }}
      RUBY_VER: ${{ matrix.ruby }}
      SPROCKETS_VER: ${{ matrix.sprockets }}
    steps:
    - uses: actions/checkout@v5
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby }}
        cache-version: rails-${{ matrix.rails }}-sprockets-${{ matrix.sprockets }}
        bundler-cache: true
    - run: npm install phantomjs-prebuilt@2.1.16 && echo $PWD/node_modules/phantomjs-prebuilt/bin >> $GITHUB_PATH
    - run: OPENSSL_CONF=/dev/null bundle exec rake
      # another option is to search for something like [PUSH_BETA_GEM] in event.payload.commits[0].message
    - name: Publish Beta to GitHub Packages
      if: ${{ github.event.ref != 'refs/heads/master' && ! contains(github.event.ref, 'refs/tags') && matrix.rails == '6.1' && matrix.ruby == 'ruby-3.0' && matrix.sprockets == '4' }}
      run: |
        set +x
        mkdir -p $HOME/.gem
        cat << EOF > ~/.gem/credentials
        ---
        :github: Bearer ${GITHUB_TOKEN}
        EOF
        chmod 0600 $HOME/.gem/credentials
        set -x

        git config --global --add safe.directory "$(pwd)"

        gem build $GEMSPEC | tee build.log
        export GEM_VERSION=$(grep Version build.log | cut -d ':' -f 2 | xargs)
        if [[ $GEM_VERSION =~ beta[0-9]*$ ]]; then
          echo 'publish beta version'
          gem push --key github --host https://rubygems.pkg.github.com/${OWNER} *.gem
        else
          echo 'Only beta versions are allowed'
          exit 1
        fi
      env:
        GEMSPEC: ${{github.event.repository.name}}.gemspec
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        OWNER: ${{github.event.repository.owner.login}}